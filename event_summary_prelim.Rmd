---
title: "Event summary"
author: "Bird Count India"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2:
    fig_caption: yes
    reference_docx: word_template.docx
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)


library(curl)
library(jsonlite)
library(tidyverse)
library(lubridate)
library(glue)
library(writexl)
library(rebird)
library(flextable)
# library(skimmr)

# Get an eBird API token and assign it to object myebirdtoken
source("token.R")
source("scripts/functions.R")


ebd <- read_csv("eBirdTaxonomy.csv")
# soib <- read_csv("../soib-v2/01_analyses_full/results/SoIB_main.csv")


# get required dates, admin units (MAKE MODIFICATIONS HERE) ###
get_dates(seq(as_date("2023-11-04"), as_date("2023-11-07"), by = "days"))
cur_region <- get_admin_codes("IN-NL", hi_arch = FALSE)
cur_region_children <- get_admin_codes(cur_region, hi_arch = TRUE)
cur_event <- "notGBBC"

```

```{r data-processing, include=FALSE}

# species lists & participation summaries
spec_list_main <- gen_spec_list(cur_region, dates_cur)
part_summ_main <- gen_part_summ(cur_region, dates_cur, spec_list_main)

spec_list_sub <- gen_spec_list(cur_region_children, dates_cur) %>% 
  filter(REGION != cur_region)
part_summ_sub <- gen_part_summ(cur_region_children, dates_cur, spec_list_sub) %>% 
  filter(REGION != cur_region)

# media summaries (only for first admin unit)
media_summ_main <- get_media_summary(first(dates_cur), last(dates_cur))

# functions to create statements from summaries
create_statement <- function(var) {
  
  if (var == "observers") {
    
    if (length(dates_cur) == 1) {
      
      number <- part_summ_main$OBSERVERS %>% as.integer()
      string <- glue("**{number} birdwatchers** from India came together")
      
      return(string)
      
    } else if (length(dates_cur) > 1) {
      
      info <- part_summ_main %>% 
        filter(TOTAL == "OBSERVERS") %>% 
        dplyr::select(starts_with("DAY")) %>% 
        pivot_longer(cols = everything(), names_to = "DAY.NO", values_to = "OBSERVERS") %>% 
        mutate(MAX = max(OBSERVERS), 
               MAX.WHEN = case_when(OBSERVERS == MAX ~ DAY.NO, 
                                    TRUE ~ NA),
               MIN = min(OBSERVERS),
               NO.DAYS = n_distinct(DAY.NO)) %>% 
        distinct(MAX, MAX.WHEN, MIN, NO.DAYS) %>% 
        filter(!is.na(MAX.WHEN))
      
      string <- glue("**Everyday, at least {info$MIN} birdwatchers** from India came together for the {info$NO.DAYS} days ({info$MAX} birdwatchers on Day {info$MAX.WHEN %>% str_remove('DAY')}!),")
      
      return(string)
      
    }
    
  } else if (var == "species") {
    
    if (length(dates_cur) == 1) {
      number <- part_summ_main$SPECIES %>% as.integer()
    } else if (length(dates_cur) > 1) {
      number <- part_summ_main %>% 
        filter(TOTAL == "SPECIES") %>% 
        pull(ALL.DAYS) %>% 
        as.integer()
    }
    
    string <- glue("**{number} species**")
    return(string)
    
  } else if (var == "checklists") {
    
    if (length(dates_cur) == 1) {
      number <- part_summ_main$CHECKLISTS %>% as.integer()
    } else if (length(dates_cur) > 1) {
      number <- part_summ_main %>% 
        filter(TOTAL == "CHECKLISTS") %>% 
        pull(ALL.DAYS) %>% 
        as.integer()
    }
    
    string <- glue("**{scales::label_comma()(number)} checklists**")
    return(string)
    
  } else if (var == "subregions") {
    
    info <- part_summ_sub %>% 
      {if (length(dates_cur) == 1) {
        filter(., if_any(c("OBSERVERS", "CHECKLISTS", "SPECIES"), ~ .x > 0))
      } else if (length(dates_cur) > 1) {
        filter(., if_any(starts_with("DAY"), ~ .x > 0))
      }} %>% 
      reframe(NO.REG = n_distinct(REGION),
              WHICH.REG = case_when(str_count(REGION, "-") == 1 ~ "states/union territories",
                                    str_count(REGION, "-") == 2 ~ "districts",
                                    TRUE ~ "UNKNOWN REGION")) %>% 
      distinct(NO.REG, WHICH.REG)
    
    string <- glue("**{info$NO.REG} {info$WHICH.REG}**")
    return(string)

  } else if (var == "media") {
    
    info <- media_summ_main %>% 
      mutate(across(everything(), ~ scales::label_comma()(.)))

    string <- glue("**{info$photo} photos** and **{info$audio} sound recordings**")
    return(string)

  }
  
}

create_ML_link <- function() {
  
  prefix <- "https://media.ebird.org/catalog?mediaType=photo&sort=rating_rank_desc&obsDtFrom="
  middle_todate <- "&obsDtTo="
  middle_region <- "&regionCode="
  
  link <- glue("{prefix}{first(dates_cur)}{middle_todate}{last(dates_cur)}{middle_region}{cur_region}")
  return(link)
  
}

what_is_next_month <- function() {
  next_date <- last(dates_cur) + months(1)
  output <- glue("{month(next_date, label = TRUE, abbr = FALSE)} {year(next_date)}")
  return(output)
}

```

```{r statements, include=FALSE}

how_many_people <- create_statement("observers")
how_many_species <- create_statement("species")
how_many_lists <- create_statement("checklists")
how_many_subregions <- create_statement("subregions")

what_subregions <- how_many_subregions %>% 
  str_extract_all("[:letter:]", simplify = TRUE) %>% 
  str_flatten()

link_to_ML <- create_ML_link()

# library(rvest)
# 
# webpage <- create_ML_link() %>% 
#   read_html() 
# 
# webpage %>% 
#   html_elements(".mediaTypeButton") %>% 
#   html_elements(".stat") %>% 
#   # html_attrs("data-v-804f50dc") %>% 
#   .[[2]]
#   html_text2()
#   
#   webpage %>% 
#     html_attr("Audio")

disclaimer <- if (cur_event == "GBBC") {
  glue("the final results will be published at the end of {what_is_next_month()}")
} else {
  "the final numbers may vary"
}

```

<br>

[Paragraph about event intro, coincidence with global event if so]

`r how_many_people` and documented `r how_many_species` in `r how_many_lists`! Participants represented `r how_many_subregions`. In addition to this, [`r create_statement("media")`](`r link_to_ML`) were uploaded to the Macaulay Library!

[Placeholder for nice ML image]

Thanks to all birdwatchers and nature enthusiasts from across the country who made this event a success. A special shout out to all those who took this opportunity to conduct public bird walks and introduce new people to the wonders of birds and nature!

```{r table1, tab.cap=glue("Total number of lists uploaded from {what_subregions}"), out.width="100%"}
part_summ_sub %>% 
  filter(TOTAL == "CHECKLISTS") %>% 
  dplyr::select(-TOTAL) %>% 
  arrange(desc(as.numeric(ALL.DAYS))) %>% 
  flextable() %>% 
  set_table_properties(layout = "autofit") %>% 
  align(align = "center", part = "all") %>%
  align(align = "left", j = c("REGION", "REGION.NAME"), part = "all") %>%
  line_spacing(space = 1, part = "all") %>% 
  padding(padding = 1.5, part = "body") %>%
  fontsize(size = 8, part = "all") %>% 
  flextable::font(fontname = "Times New Roman", part = "all")
```

```{r table2, tab.cap=glue("Total number of species reported from {what_subregions}"), out.width="100%"}
part_summ_sub %>% 
  filter(TOTAL == "SPECIES") %>% 
  dplyr::select(-TOTAL) %>% 
  arrange(desc(as.numeric(ALL.DAYS))) %>% 
  flextable() %>% 
  set_table_properties(layout = "autofit") %>% 
  align(align = "center", part = "all") %>%
  align(align = "left", j = c("REGION", "REGION.NAME"), part = "all") %>%
  line_spacing(space = 1, part = "all") %>% 
  padding(padding = 1.5, part = "body") %>%
  fontsize(size = 8, part = "all") %>% 
  flextable::font(fontname = "Times New Roman", part = "all")
```

[Placeholder for birding image]

Thank you to everyone for interacting with the public and students, organising bird walks and talks, and promoting the joy of birdwatching!

**Note:** This is a preliminary summary; `r disclaimer`.
